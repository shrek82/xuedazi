# 拼音大冒险 (xuedazi) - 游戏规则与需求设计说明书

## 1. 游戏概述
**拼音大冒险** 是一款旨在通过游戏化方式帮助用户（特别是儿童）学习拼音打字、提升打字速度并积累词汇量的 macOS 应用程序。游戏通过丰富的视觉反馈、声音激励和经济系统，让枯燥的练习变得有趣。

---

## 2. 核心游戏模式

### 2.1 标准闯关模式 (Standard Mode)
适用于大多数学习场景，包含多个难度级别。
*   **玩法**: 屏幕显示汉字和对应的拼音，用户需通过键盘输入正确的拼音字母。
*   **目标**: 正确输入所有拼音字母以完成当前词汇，进入下一个。
*   **输入规则**:
    *   **逐字匹配**: 用户输入的字符必须与目标拼音完全一致。
    *   **忽略大小写**: 系统自动处理大小写，通常接受小写输入。
    *   **标点符号**: 标点符号通常自动跳过或由系统自动填充，无需用户输入（视具体实现而定，目前逻辑主要关注字母）。
*   **难度分级**:
    *   **入门**: 单字 (Easy)
    *   **进阶**: 词语 (Medium)、成语 (Hard)、歇后语 (Xiehouyu)
    *   **拓展**: 英语单词 (English)、编程词汇 (Programming)、古诗词 (Tang Poetry) 等。

### 2.2 练习模式 (Practice Mode)
专注于基础键位和字母反应速度。
*   **包含类型**: 字母游戏 (Letter Game)、基准键练习 (Home Row)。
*   **玩法**: 屏幕上方掉落字母或显示特定键位，用户需快速按下对应按键。
*   **目标**: 在字母落地前或规定时间内消除目标。

---

## 3. 游戏配置与参数 (Settings)

所有配置项均可在“设置”面板中调整，并实时生效。

### 3.1 经济与奖励配置
| 配置项名称 | 默认值 | 说明 |
| :--- | :--- | :--- |
| **字母输入奖励** (`moneyPerLetter`) | 0.05 | **核心经济来源**。每正确输入一个**拼音字母**，即刻获得该金额的金币。注意：仅限字母，不包含汉字或整词完成。 |
| **错误扣除金币** (`penaltyPerError`) | 0.0 | 每输入一个**错误字母**，扣除该金额的金币。默认为 0（不扣钱）。 |
| **连击奖励阈值** (`comboBonusThreshold`) | 10 | 连续正确输入多少个字母触发一次连击奖励。 |
| **连击奖励金额** (`comboBonusMoney`) | 0.1 | 触发连击奖励时获得的额外金币。 |
| **随机奖励概率** (`randomRewardChance`) | 5% | 每次正确输入字母时，有概率触发“幸运掉落”。 |
| **随机奖励金额** | 0.5 - 1.0 | “幸运掉落”触发时获得的随机金币范围。 |
| **阶段奖励阈值** (`milestoneLetterCount`) | 50 | 累计正确输入多少个字母触发一次阶段性大奖。 |
| **阶段奖励金额** (`milestoneBonusMoney`) | 1.0 | 触发阶段奖励时获得的额外金币。 |

### 3.2 生命值配置 (Health System)
| 配置项名称 | 默认值 | 说明 |
| :--- | :--- | :--- |
| **初始生命值** (`maxHealth`) | 5 | 游戏开始时的生命点数（红心）。设为 0 即开启“无敌模式”。 |
| **错误扣血** (`healthPerError`) | 1 | 每输入一个**错误字母**，扣除的生命点数。可设为 0（无惩罚）。 |
| **购买生命花费** (`costPerHealth`) | 5.0 | 点击顶部生命栏加号购买 1 点生命值所需的金币。 |

### 3.3 特效概率配置
| 配置项名称 | 概率 | 奖励范围 | 说明 |
| :--- | :--- | :--- | :--- |
| **随机宝藏** (`Treasure`) | 1% | 0.01 - 0.03 | 触发全屏宝藏雨特效。 |
| **随机流星** (`Meteor`) | 1% | 0.01 - 0.02 | 触发全屏流星划过特效。 |

### 3.4 辅助功能配置
*   **朗读前延迟**: 输入完成后等待多久开始朗读（秒）。
*   **单字朗读倍速**: 朗读单个字母或汉字时的语速倍率。

---

## 4. 详细交互规则 (Interaction Rules)

### 4.1 输入验证机制
*   **输入流处理**:
    *   用户在键盘的每一次敲击都会被捕获。
    *   系统将用户输入分为“**有效前缀**”（已验证正确的字符）和“**新增字符**”。
*   **逐字验证**:
    *   对于每一个新增字符，系统会将其与目标拼音的对应位置进行比对。
    *   **正确**:
        1.  播放“正确”音效 (`SoundManager.shared.playCorrectLetter()`)。
        2.  **增加金币**（根据 `moneyPerLetter` 配置）。
        3.  **增加连击数** (`Combo`)。
        4.  **增加进度**（如果完成了当前汉字的拼音，触发汉字朗读）。
        5.  界面上对应字母变为**绿色**。
    *   **错误**:
        1.  播放“错误/报警”音效 (`SoundManager.shared.playWrongLetter()`)。
        2.  屏幕/输入框触发**震动反馈**（屏幕整体微幅抖动）。
        3.  **扣除生命值**（根据 `healthPerError` 配置）。
        4.  **扣除金币**（根据 `penaltyPerError` 配置）。
        5.  **重置连击数** (`Combo` 归零)。
        6.  **强制回退**: 错误的字符会被立即丢弃，**绝不会**进入输入框保留，确保界面上不会出现错误的绿色字符。

### 4.2 词汇完成 (Word Completion)
*   当一个词汇（或成语/句子）的所有拼音字母都输入正确后：
    1.  播放“成功”音效 (`SoundManager.shared.playSuccess()`)。
    2.  增加游戏**分数** (`Score`)，计算公式：`10 + min(连击数 / 5 * 2, 20)`。注意：此处只加分，**不加金币**。
    3.  显示全屏成功特效：
        *   **粒子爆发**：屏幕中央爆发五颜六色的星星粒子。
        *   **文字弹跳**：当前汉字和拼音区域瞬间放大并回弹。
    4.  朗读当前词汇/句子。
    5.  根据配置的延迟时间 (`delayStandard` 等)，自动跳转到下一题。

### 4.3 游戏结束 (Game Over)
*   **触发条件**: 生命值 (`currentHealth`) 降为 0。
*   **结果**:
    *   停止所有计时器和语音。
    *   显示“Game Over”结算面板。
    *   展示本局得分、金币获取情况和最大连击数。
    *   提供“返回主菜单”选项。

---

## 5. UI 与体验细节 (User Experience)

### 5.1 视觉反馈 (Visual Feedback)
*   **输入字符状态**:
    *   **待输入**: 黄色/橙色 (Waiting)。
    *   **已正确输入**: 绿色 (Correct)。
    *   **当前输入错误**: 瞬间变红 (Wrong) 并触发震动，随后立即重置。
*   **金币奖励**:
    *   每次获得金币时，右上角金币栏上方会飘出绿色的数字（如 `+0.005`），带有向上浮动和渐隐动画。
    *   金币总数滚动更新，精确到小数点后 3 位。
*   **生命值**:
    *   生命值以红心图标显示，扣血时图标变为空心。
    *   支持动态购买生命，点击“+”号会有缩放动画。
*   **连击火焰**:
    *   当连击数超过 30 时，屏幕边缘会出现持续燃烧的火焰特效，增强紧张感和成就感。
*   **背景**:
    *   柔和的动态渐变背景 (`Color.themeBgSky50`)，保护视力。

### 5.2 听觉反馈 (Audio Feedback)
*   **按键音**: 每次按键（无论对错）都有轻微的机械键盘敲击声。
*   **TTS 朗读**:
    *   **游戏开始时**: 朗读第一个词汇。
    *   **单字完成时**: 朗读该汉字（除非是单字模式，则在最后朗读）。
    *   **整词完成时**: 朗读完整词汇/句子。
    *   **支持多引擎**: 系统语音 (AVSpeech) 和讯飞语音 (XunFei)，可在设置中切换。
*   **旁白系统**:
    *   根据游戏事件（开始、连击、错误、低血量、胜利）触发个性化语音包（如“海绵宝宝”、“傲娇猫”等）。

### 5.3 虚拟键盘 (Virtual Keyboard)
*   **指法引导**:
    *   键盘按键根据标准指法分区着色（粉、橙、黄、绿），提示用户使用正确的手指。
    *   当前**目标按键**会高亮显示，并伴有呼吸灯效果（Glow），引导用户视线。
*   **动态反馈**:
    *   按键被按下时会有下沉动画。
    *   按键松开时会有回弹动画。

### 5.4 辅助功能与微调
*   **释义显示**: 对于成语、古诗等高难度词汇，屏幕下方会显示灰色的释义/翻译。
*   **延迟调节**:
    *   用户可自定义“朗读前延迟”和“跳转延迟”，适应不同学习速度。
*   **字体优化**:
    *   拼音使用等宽字体或专门优化的拼音字体，确保对齐。
    *   汉字使用大号楷体/圆体，清晰易读。
